# نظام الشات المتكامل - Petut App

## الوصف
تم إنشاء نظام شات متكامل يسمح للمستخدمين بالتواصل مع بعضهم البعض من خلال:
- التعليق على البوستات
- الضغط على صورة صاحب التعليق أو البوست لعرض البروفايل
- بدء محادثة من البروفايل
- نظام شات في الوقت الفعلي مع Firebase

## الميزات المضافة

### 1. نماذج البيانات (Models)
- **Chat.dart**: نموذج المحادثة والرسائل
- **Message.dart**: نموذج الرسائل مع أنواع مختلفة (نص، صورة)

### 2. الخدمات (Services)
- **ChatService**: خدمة إدارة المحادثات والرسائل مع Firebase
  - إنشاء محادثة جديدة أو الحصول على محادثة موجودة
  - إرسال الرسائل
  - تتبع الرسائل غير المقروءة
  - تحديث حالة القراءة

### 3. الشاشات (Screens)
- **ChatsListScreen**: قائمة المحادثات مع عداد الرسائل غير المقروءة
- **ChatScreen**: شاشة المحادثة الفردية
- **ProfileViewScreen**: عرض البروفايل مع إمكانية بدء المحادثة

### 4. التحديثات على الشاشات الموجودة
- **PostDetailsScreen**: إضافة إمكانية الضغط على صور المعلقين
- **CommunityScreen**: إضافة إمكانية الضغط على صور أصحاب البوستات
- **HomeScreen**: إضافة أيقونة الشات في شريط التطبيق

## هيكل قاعدة البيانات في Firebase

### مجموعة Chats
```
chats/{chatId}
├── participants: [userId1, userId2]
├── lastMessage: string
├── lastMessageTime: timestamp
├── lastMessageSenderId: string
├── unreadCount: {userId1: number, userId2: number}
└── createdAt: timestamp
```

### مجموعة Messages
```
messages/{messageId}
├── chatId: string
├── senderId: string
├── content: string
├── timestamp: timestamp
├── type: string (text/image)
└── isRead: boolean
```

## كيفية الاستخدام

### 1. بدء محادثة
- اذهب إلى أي بوست في المجتمع
- اضغط على صورة صاحب البوست أو المعلق
- ستفتح صفحة البروفايل
- اضغط على زر "Start Chat"

### 2. عرض المحادثات
- من الشاشة الرئيسية، اضغط على أيقونة الشات
- ستظهر قائمة بجميع المحادثات
- المحادثات مرتبة حسب آخر رسالة
- عداد الرسائل غير المقروءة يظهر بجانب كل محادثة

### 3. إرسال الرسائل
- ادخل إلى أي محادثة
- اكتب رسالتك في الحقل السفلي
- اضغط على زر الإرسال
- الرسائل تظهر في الوقت الفعلي

## قواعد الأمان
تم إنشاء قواعد أمان شاملة في Firestore تضمن:
- المستخدمون يمكنهم فقط قراءة وكتابة محادثاتهم الخاصة
- الرسائل محمية ولا يمكن الوصول إليها إلا من المشاركين في المحادثة
- التحقق من الهوية مطلوب لجميع العمليات

## التوافق مع الويب
النظام متوافق تماماً مع الويب ويستخدم نفس قاعدة البيانات، مما يعني:
- المحادثات متزامنة بين التطبيق والويب
- يمكن بدء محادثة من التطبيق ومتابعتها من الويب والعكس
- جميع الرسائل محفوظة في Firebase وقابلة للوصول من أي منصة

## الملفات المضافة
1. `lib/models/Chat.dart`
2. `lib/services/chat_service.dart` (النسخة الأصلية)
3. `lib/services/simple_chat_service.dart` (النسخة المبسطة - المستخدمة حالياً)
4. `lib/screens/chats_list_screen.dart`
5. `lib/screens/chat_screen.dart`
6. `lib/screens/profile_view_screen.dart`
7. `firestore_security_rules.txt`
8. `FIREBASE_INDEXES_SETUP.md`

## الملفات المحدثة
1. `lib/screens/post_details_screen.dart`
2. `lib/screens/community_screen.dart`
3. `lib/screens/home_screen.dart`

## حل مشاكل الفهارس (Indexes)
إذا ظهرت أخطاء تتعلق بالفهارس:
1. اتبع التعليمات في `FIREBASE_INDEXES_SETUP.md`
2. أو انقر على الرابط في رسالة الخطأ لإنشاء الفهرس تلقائياً
3. النظام يستخدم حالياً `SimpleChatService` لتجنب معظم مشاكل الفهارس

النظام جاهز للاستخدام ولا يحتاج إلى مكتبات إضافية حيث يستخدم المكتبات الموجودة بالفعل في المشروع.